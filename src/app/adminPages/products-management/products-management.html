<!-- Toast Notifications -->
<app-toast></app-toast>

<!-- Loading Overlay -->
<app-loading [isLoading]="isLoading" [overlay]="true" text="Loading products..."></app-loading>

<div class="space-y-6">
  <!-- Header -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pb-6">
  <div>
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
      {{ languageService.currentLanguage() === 'en' ? 'Products Management' : 'إدارة المنتجات' }}
    </h1>
    <p class="text-gray-600 dark:text-gray-400">
      {{ languageService.currentLanguage() === 'en' 
        ? 'View and monitor all handmade products' 
        : 'عرض ومراقبة جميع المنتجات اليدوية' }}
    </p>
  </div>
  <div class="flex gap-2">
    <button
      *ngIf="selectedProducts.size > 0"
      (click)="openBulkDeleteModal()"
      class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 gap-2"
    >
      <i class="fa-solid fa-trash w-4 h-4"></i>
      Delete Selected ({{ selectedProducts.size }})
    </button>
    <button
      (click)="openCreateModal()"
      class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 gap-2"
    >
      <i class="fa-solid fa-plus w-4 h-4"></i>
      {{ languageService.currentLanguage() === 'en' ? 'Add Product' : 'إضافة منتج' }}
    </button>
  </div>
</div>

  <!-- Category Filter -->
  <div class="flex flex-wrap gap-2">
    <button
      *ngFor="let category of categoryFilters"
      (click)="setCategoryFilter(category.value)"
      [class]="getFilterButtonClass(category.value)"
      class="px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2"
    >
      <i [class]="category.icon" class="w-4 h-4"></i>
      {{ languageService.currentLanguage() === 'en' ? category.label : 
         category.value === 'all' ? 'الكل' :
         category.value === 'jewelry' ? 'مجوهرات' :
         category.value === 'pottery' ? 'فخار' :
         category.value === 'textiles' ? 'منسوجات' :
         category.value === 'woodwork' ? 'نجارة' : 'أخرى' }}
      <span class="bg-white dark:bg-gray-800 text-xs px-2 py-1 rounded-full">
        {{ getCategoryCount(category.value) }}
      </span>
    </button>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6  pb-5">
    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Products</p>
          <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ products.length }}</p>
        </div>
        <div class="w-12 h-12 bg-blue-50 dark:bg-blue-900/50 rounded-lg flex items-center justify-center">
          <i class="fas fa-box w-6 h-6 text-blue-600 dark:text-blue-400"></i>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Active Products</p>
          <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ getActiveProductsCount() }}</p>
        </div>
        <div class="w-12 h-12 bg-green-50 dark:bg-green-900/50 rounded-lg flex items-center justify-center">
          <i class="fas fa-shopping-cart w-6 h-6 text-green-600 dark:text-green-400"></i>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Sales</p>
          <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ getTotalSales() }}</p>
        </div>
        <div class="w-12 h-12 bg-purple-50 dark:bg-purple-900/50 rounded-lg flex items-center justify-center">
          <i class="fas fa-dollar-sign w-6 h-6 text-purple-600 dark:text-purple-400"></i>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Avg Rating</p>
          <div class="flex items-center gap-2">
            <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ getAverageRating() }}</p>
            <div class="flex items-center">
              <i 
                *ngFor="let star of [1,2,3,4,5]" 
                [class]="getAverageRatingNumber() >= star ? 'fas fa-star text-yellow-500' : 'far fa-star text-gray-300'"
                class="w-3 h-3"
              ></i>
            </div>
          </div>
        </div>
        <div class="w-12 h-12 bg-yellow-50 dark:bg-yellow-900/50 rounded-lg flex items-center justify-center">
          <i class="fas fa-star w-6 h-6 text-yellow-600 dark:text-yellow-400"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Actions and Items Per Page -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pb-4">
    <div class="flex items-center gap-4">
      <label class="flex items-center">
        <input
          type="checkbox"
          [checked]="isAllSelected"
          [indeterminate]="isIndeterminate"
          (change)="toggleAllProducts()"
          class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
        />
        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Select All</span>
      </label>
      <span class="text-sm text-gray-500 dark:text-gray-400">
        {{ selectedProducts.size }} of {{ products.length }} selected
      </span>
    </div>
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-700 dark:text-gray-300">Items per page:</label>
      <select
        [value]="itemsPerPage"
        (change)="changeItemsPerPage(+$any($event.target).value)"
        class="rounded border-gray-300 dark:border-gray-600 text-sm"
      >
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
    </div>
  </div>

  <!-- Data Table -->
  <app-data-table
    title="Products"
    subtitle="All handmade products in the marketplace"
    [data]="products"
    [columns]="columns"
    [actions]="actions"
    searchPlaceholder="Search products..."
    (actionClicked)="onAction($event)"
    (exportClicked)="onExport()"
  ></app-data-table>

  <!-- Pagination -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pt-4">
    <div class="text-sm text-gray-700 dark:text-gray-300">
      Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to {{ getEndIndex() }} of {{ totalItems }} results
    </div>
    <div class="flex items-center space-x-2">
      <button
        (click)="changePage(currentPage - 1)"
        [disabled]="currentPage === 1"
        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Previous
      </button>
      <button
        *ngFor="let page of paginationPages"
        (click)="changePage(page)"
        [class.bg-blue-600]="page === currentPage"
        [class.text-white]="page === currentPage"
        [class.bg-white]="page !== currentPage"
        [class.text-gray-700]="page !== currentPage"
        class="px-3 py-2 text-sm font-medium border border-gray-300 rounded-md hover:bg-gray-50"
      >
        {{ page }}
      </button>
      <button
        (click)="changePage(currentPage + 1)"
        [disabled]="currentPage === totalPages"
        class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Next
      </button>
    </div>
  </div>

  <!-- Bulk Delete Modal -->
  <app-modal
    [isOpen]="showBulkDeleteModal"
    title="Delete Selected Products"
    [confirmText]="isDeleting ? 'Deleting...' : 'Delete All'"
    cancelText="Cancel"
    confirmButtonType="danger"
    [confirmDisabled]="isDeleting"
    (closed)="closeBulkDeleteModal()"
    (confirmed)="confirmBulkDelete()"
  >
    <div class="text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/50 mb-4">
        <i class="fa-solid fa-trash w-6 h-6 text-red-600 dark:text-red-400"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Are you sure?</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400">
        This action cannot be undone. This will permanently delete {{ selectedProducts.size }} selected products.
      </p>
    </div>
  </app-modal>

  <!-- Add/Edit Product Modal -->
  <app-modal
    [isOpen]="showModal"
    [title]="isEditMode ? 'Edit Product' : 'Add Product'"
    [confirmText]="isSaving ? 'Saving...' : (isEditMode ? 'Save Changes' : 'Add Product')"
    [cancelText]="'Cancel'"
    confirmButtonType="primary"
    [confirmDisabled]="isSaving"
    (closed)="closeModal()"
    (confirmed)="saveProduct()"
  >
    <form [formGroup]="productForm" class="space-y-6">
      <!-- Title -->
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Title <span class="text-red-500">*</span>
        </label>
        <input 
          type="text" 
          formControlName="title" 
          [class.border-red-500]="isFieldInvalid('title')"
          [class.border-gray-300]="!isFieldInvalid('title')"
          class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
          placeholder="Enter product title (3-100 characters)" 
        />
        <div *ngIf="isFieldInvalid('title')" class="mt-1 text-sm text-red-600 dark:text-red-400">
          {{ getFieldError('title') }}
        </div>
      </div>

      <!-- Description -->
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Description <span class="text-red-500">*</span>
          <span class="text-gray-400 text-xs">(10-1000 characters)</span>
        </label>
        <textarea 
          formControlName="description" 
          rows="4" 
          [class.border-red-500]="isFieldInvalid('description')"
          [class.border-gray-300]="!isFieldInvalid('description')"
          class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
          placeholder="Enter detailed product description"
        ></textarea>
        <div *ngIf="isFieldInvalid('description')" class="mt-1 text-sm text-red-600 dark:text-red-400">
          {{ getFieldError('description') }}
        </div>
        <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">
          {{ productForm.get('description')?.value?.length || 0 }}/1000 characters
        </div>
      </div>

      <!-- Price and Quantity -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Price <span class="text-red-500">*</span>
            <span class="text-gray-400 text-xs">($0.01 - $999,999.99)</span>
          </label>
          <input 
            type="number" 
            formControlName="price" 
            min="0.01" 
            max="999999.99"
            step="0.01"
            [class.border-red-500]="isFieldInvalid('price')"
            [class.border-gray-300]="!isFieldInvalid('price')"
            class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
            placeholder="0.00" 
          />
          <div *ngIf="isFieldInvalid('price')" class="mt-1 text-sm text-red-600 dark:text-red-400">
            {{ getFieldError('price') }}
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Quantity <span class="text-red-500">*</span>
            <span class="text-gray-400 text-xs">(0-9999)</span>
          </label>
          <input 
            type="number" 
            formControlName="quantity" 
            min="0" 
            max="9999"
            [class.border-red-500]="isFieldInvalid('quantity')"
            [class.border-gray-300]="!isFieldInvalid('quantity')"
            class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
            placeholder="0" 
          />
          <div *ngIf="isFieldInvalid('quantity')" class="mt-1 text-sm text-red-600 dark:text-red-400">
            {{ getFieldError('quantity') }}
          </div>
        </div>
      </div>

      <!-- Service ID -->
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Service ID <span class="text-red-500">*</span>
        </label>
        <input 
          type="number" 
          formControlName="serviceId" 
          min="1" 
          [class.border-red-500]="isFieldInvalid('serviceId')"
          [class.border-gray-300]="!isFieldInvalid('serviceId')"
          class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" 
          placeholder="Enter service ID" 
        />
        <div *ngIf="isFieldInvalid('serviceId')" class="mt-1 text-sm text-red-600 dark:text-red-400">
          {{ getFieldError('serviceId') }}
        </div>
      </div>

      <!-- Product Image -->
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Product Image <span class="text-red-500" *ngIf="!isEditMode">*</span>
          <span class="text-gray-400 text-xs">(JPG, PNG, max 5MB)</span>
        </label>
        <input 
          type="file" 
          (change)="onFileSelected($event)" 
          accept="image/*" 
          [class.border-red-500]="!isEditMode && !selectedFile && productForm.touched"
          [class.border-gray-300]="isEditMode || selectedFile || !productForm.touched"
          class="w-full px-4 py-2 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" 
        />
        
        <!-- File validation error -->
        <div *ngIf="!isEditMode && !selectedFile && productForm.touched" class="mt-1 text-sm text-red-600 dark:text-red-400 flex items-center">
          <i class="fas fa-exclamation-circle mr-1"></i>
          Please select an image for the product
        </div>
        
        <!-- File preview -->
        <div *ngIf="selectedFile" class="mt-3">
          <div class="flex items-center space-x-3">
            <img [src]="previewImageUrl" alt="Preview" class="w-20 h-20 object-cover rounded-lg border-2 border-green-200" />
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900 dark:text-white">{{ selectedFile.name }}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">{{ (selectedFile.size / 1024).toFixed(1) }} KB</p>
              <div class="flex items-center mt-1">
                <i class="fas fa-check-circle text-green-500 mr-1"></i>
                <span class="text-xs text-green-600 dark:text-green-400">Image selected</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Current image (edit mode) -->
        <div *ngIf="!selectedFile && isEditMode && previewImageUrl" class="mt-3">
          <div class="flex items-center space-x-3">
            <img [src]="previewImageUrl" alt="Current" class="w-20 h-20 object-cover rounded-lg border-2 border-blue-200" />
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-900 dark:text-white">Current Image</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Select a new file to replace</p>
            </div>
          </div>
        </div>
      </div>
    </form>
  </app-modal>

  <!-- Delete Confirmation Modal -->
  <app-modal
    [isOpen]="showDeleteModal"
    [title]="'Delete Product'"
    [confirmText]="isDeleting ? 'Deleting...' : 'Delete'"
    [cancelText]="'Cancel'"
    confirmButtonType="danger"
    [confirmDisabled]="isDeleting"
    (closed)="closeDeleteModal()"
    (confirmed)="confirmDelete()"
  >
    <div class="text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/50 mb-4">
        <i class="fa-solid fa-trash w-6 h-6 text-red-600 dark:text-red-400"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Are you sure?</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400">This action cannot be undone. This will permanently delete the product.</p>
      <div *ngIf="productToDelete" class="mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
        <p class="font-medium text-gray-900 dark:text-white">{{ productToDelete.name }}</p>
      </div>
    </div>
  </app-modal>

  <!-- Product Details Modal -->
  <app-modal
    [isOpen]="showDetailsModal"
    title="Product Details"
    [showConfirmButton]="false"
    cancelText="Close"
    (closed)="closeDetailsModal()"
  >
    <div *ngIf="selectedProduct" class="space-y-6">
      <!-- Product Images -->
      <div *ngIf="selectedProduct?.images && selectedProduct.images.length > 0">
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">Product Images</label>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <img
              *ngFor="let image of selectedProduct.images"
              [src]="image"
              [alt]="selectedProduct?.name"
              class="w-full h-32 object-cover rounded-lg border border-gray-200 dark:border-gray-700"
            />
          </div>
        </div>
      </div>

      <!-- Product Info -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Product ID</label>
          <p class="text-lg font-bold text-blue-600 dark:text-blue-400">#{{ selectedProduct?.id }}</p>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Status</label>
          <span [class]="getBadgeClass(selectedProduct?.status || '')" class="inline-flex px-3 py-1 text-sm font-semibold rounded-full">
            {{ selectedProduct?.status | titlecase }}
          </span>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Product Name</label>
          <p class="text-gray-900 dark:text-white font-semibold text-lg">{{ selectedProduct?.name }}</p>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Price</label>
          <p class="text-2xl font-bold text-green-600 dark:text-green-400">{{ selectedProduct?.price | currency }}</p>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Stock Quantity</label>
          <div class="flex items-center">
            <i class="fas fa-boxes w-4 h-4 mr-2 text-gray-600 dark:text-gray-400"></i>
            <p class="text-gray-900 dark:text-white font-semibold">{{ selectedProduct?.stock }} units</p>
          </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Category</label>
          <p class="text-gray-900 dark:text-white font-semibold">{{ selectedProduct?.category }}</p>
        </div>
      </div>

      <!-- Additional Stats -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-6">
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Rating</label>
          <div class="flex items-center">
            <div class="flex items-center mr-2">
              <i 
                *ngFor="let star of [1,2,3,4,5]" 
                [class]="getSafeRating(selectedProduct?.rating) >= star ? 'fas fa-star text-yellow-500' : 'far fa-star text-gray-300'"
                class="w-4 h-4"
              ></i>
            </div>
            <span class="text-gray-900 dark:text-white font-semibold">{{ getSafeRating(selectedProduct?.rating).toFixed(1) }}</span>
            <span class="text-gray-500 dark:text-gray-400 ml-1">({{ selectedProduct?.reviewCount || 0 }} reviews)</span>
          </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Sales</label>
          <div class="flex items-center">
            <i class="fas fa-chart-line w-4 h-4 mr-2 text-green-600 dark:text-green-400"></i>
            <span class="text-gray-900 dark:text-white font-semibold">{{ selectedProduct?.soldCount || 0 }} sold</span>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div *ngIf="selectedProduct?.description" class="mt-6">
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-2">Description</label>
          <p class="text-gray-900 dark:text-white leading-relaxed">{{ selectedProduct?.description }}</p>
        </div>
      </div>

      <!-- Tags -->
      <div *ngIf="selectedProduct?.tags && selectedProduct.tags.length > 0" class="mt-6">
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">Tags</label>
          <div class="flex flex-wrap gap-2">
            <span
              *ngFor="let tag of selectedProduct.tags"
              class="px-3 py-1 bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 text-xs font-medium rounded-full"
            >
              {{ tag }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </app-modal>

</div>